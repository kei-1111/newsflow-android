name: Test

on:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read
      pull-requests: write
      checks: write

    env:
      GITHUB_ACTOR: ${{ github.actor }}
      GITHUB_TOKEN: ${{ secrets.GPR_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run unit tests
        run: ./gradlew test

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: test-reports
          path: '**/build/reports/tests/**'
          retention-days: 7

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: test-results
          path: '**/build/test-results/**/*.xml'
          retention-days: 7

      - name: Check test results
        if: always()
        run: |
          echo "Checking test results..."
          TEST_RESULTS=$(find . -name "TEST-*.xml" -type f)

          if [ -z "$TEST_RESULTS" ]; then
            echo "::warning::No test results found"
            exit 0
          fi

          HAS_FAILURES=false
          for result in $TEST_RESULTS; do
            echo "Checking $result"
            if grep -q 'failures="[1-9]' "$result" 2>/dev/null || grep -q 'errors="[1-9]' "$result" 2>/dev/null; then
              echo "::error::Test failures found in $result"
              HAS_FAILURES=true
            fi
          done

          if [ "$HAS_FAILURES" = true ]; then
            echo "::error::Tests failed. Check the reports for details."
            exit 1
          else
            echo "âœ“ All tests passed"
          fi

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            // ãƒ†ã‚¹ãƒˆçµæžœXMLã‚’è§£æž
            const testResults = execSync('find . -name "TEST-*.xml" -type f').toString().trim();
            const files = testResults ? testResults.split('\n') : [];

            let totalTests = 0;
            let totalFailures = 0;
            let totalErrors = 0;
            let totalSkipped = 0;

            for (const file of files) {
              if (!file) continue;
              const content = fs.readFileSync(file, 'utf8');
              const testsMatch = content.match(/tests="(\d+)"/);
              const failuresMatch = content.match(/failures="(\d+)"/);
              const errorsMatch = content.match(/errors="(\d+)"/);
              const skippedMatch = content.match(/skipped="(\d+)"/);

              if (testsMatch) totalTests += parseInt(testsMatch[1]);
              if (failuresMatch) totalFailures += parseInt(failuresMatch[1]);
              if (errorsMatch) totalErrors += parseInt(errorsMatch[1]);
              if (skippedMatch) totalSkipped += parseInt(skippedMatch[1]);
            }

            const passed = totalTests - totalFailures - totalErrors - totalSkipped;
            const hasFailures = totalFailures > 0 || totalErrors > 0;

            let body = '## ðŸ§ª Unit Test Results\n\n';

            if (totalTests === 0) {
              body += 'âš ï¸ **No test results found.**\n';
            } else if (hasFailures) {
              body += `âŒ **${totalFailures + totalErrors} test(s) failed!**\n\n`;
              body += `| Status | Count |\n|--------|-------|\n`;
              body += `| âœ… Passed | ${passed} |\n`;
              body += `| âŒ Failed | ${totalFailures} |\n`;
              body += `| âš ï¸ Errors | ${totalErrors} |\n`;
              body += `| â­ï¸ Skipped | ${totalSkipped} |\n`;
              body += `| **Total** | **${totalTests}** |\n`;
              body += '\nðŸ“¥ Download the `test-reports` artifact for details.\n';
            } else {
              body += `âœ… **All ${totalTests} tests passed!**\n\n`;
              if (totalSkipped > 0) {
                body += `(${totalSkipped} skipped)\n`;
              }
            }

            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŽ¢ã—ã¦æ›´æ–° or æ–°è¦ä½œæˆ
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Unit Test Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }